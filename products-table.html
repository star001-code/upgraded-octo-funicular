<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>📊 جدول المنتجات (GDS)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{--bg:#0f172a;--card:#111827;--line:#1f2937;--ink:#e5e7eb;--muted:#94a3b8;--accent:#60a5fa}
  body{font-family:Arial,"Noto Naskh Arabic",sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:24px}
  .card{max-width:1200px;margin:auto;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:20px}
  h1{margin:0 0 12px}
  .row{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
  input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--ink)}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--ink);cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{border-bottom:1px solid var(--line);padding:10px;text-align:center}
  th{background:#0b1220}
  td:first-child{text-align:right}
  .count{font-size:12px;color:var(--muted);margin-top:6px}
  .warn{color:#fca5a5}
</style>
</head>
<body>
<div class="card">
  <h1>📊 جدول المنتجات (اضغط المنتج لفتح الحاسبة)</h1>
  <div class="row">
    <input id="q" type="text" placeholder="ابحث باسم المنتج..." oninput="filter()">
    <label for="file" class="btn">📂 تحميل JSON</label>
    <input id="file" type="file" accept=".json,application/json" style="display:none">
  </div>
  <div id="count" class="count">—</div>
  <div id="msg" class="count"></div>

  <table id="tbl">
    <thead>
      <tr>
        <th>المنتج</th>
        <th>GDS_MIN</th>
        <th>GDS_MAX</th>
        <th>GDS_YER</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let DB=[], VIEW=[];
const $ = s=>document.querySelector(s);
const normalize = s => (s||'').toString().trim().replace(/\s+/g,' ').toLowerCase();
const fmt = x => {const n=Number(x);return isFinite(n)?n.toLocaleString('ar-IQ',{maximumFractionDigits:3}):'-';};

function prepare(arr){
  return arr.map(r=>{
    const product = r.product ?? r.GDS_DS2 ?? r.name ?? "";
    const min = Number(r.GDS_MIN), max = Number(r.GDS_MAX);
    const yer = (r.GDS_YER!=null && r.GDS_YER!=="") ? Number(r.GDS_YER)
              : (isFinite(min)&&isFinite(max)) ? (min+max)/2 : null;
    return {product, GDS_MIN:min, GDS_MAX:max, GDS_YER:yer};
  }).filter(r=>r.product);
}

function render(){
  const tb=$("#tbl tbody"); tb.innerHTML="";
  const frag=document.createDocumentFragment();
  VIEW.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><a href="product-search.html?name=${encodeURIComponent(r.product)}">${r.product}</a></td>
      <td>${fmt(r.GDS_MIN)}</td>
      <td>${fmt(r.GDS_MAX)}</td>
      <td><b>${fmt(r.GDS_YER)}</b></td>`;
    frag.appendChild(tr);
  });
  tb.appendChild(frag);
  $("#count").textContent = `عدد النتائج: ${VIEW.length.toLocaleString('ar-IQ')}${DB.length?` من ${DB.length.toLocaleString('ar-IQ')}`:""}`;
}

function filter(){
  const q = normalize($("#q").value);
  VIEW = !q ? DB.slice() : DB.filter(r=>normalize(r.product).includes(q));
  render();
}

(async function boot(){
  try{
    const res = await fetch('products.json',{cache:'no-store'});
    if(!res.ok) throw new Error(res.status);
    const json = await res.json();
    DB = prepare(json); VIEW = DB.slice(); render();
    $("#msg").textContent = "";
  }catch(e){
    $("#msg").innerHTML = `<span class="warn">⚠️ لم أستطع قراءة products.json تلقائيًا. حمّل الملف يدويًا من الزر (📂 تحميل JSON).</span>`;
  }
})();

document.getElementById('file').addEventListener('change', (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      DB = prepare(JSON.parse(reader.result));
      VIEW = DB.slice(); render(); $("#msg").textContent="";
    }catch(err){ alert('JSON غير صالح: '+err.message); }
  };
  reader.readAsText(f,'utf-8');
});
</script>
</body>
</html>
