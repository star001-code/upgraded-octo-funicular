<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>🔎 الحاسبة (GDS_YER × وزن × سعر الصرف × النسبة)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:Arial,"Noto Naskh Arabic",sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:24px}
  .card{max-width:720px;margin:auto;background:#111827;border:1px solid #1f2937;border-radius:14px;padding:20px}
  h1{margin:0 0 16px}
  label{display:block;color:#aab3c5;margin:8px 0 4px}
  input,button{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  button{background:#2563eb;cursor:pointer;margin-top:10px}
  .result{margin-top:16px;padding:14px;border-radius:12px;background:#0b1220;line-height:1.8}
  .kv{display:grid;grid-template-columns:1fr auto;gap:8px;padding:6px 0;border-bottom:1px solid #1f2937}
  .warn{color:#fca5a5;font-size:12px}
</style>
</head>
<body>
<div class="card">
  <h1>🔎 تفاصيل المنتج + حساب فرق الرسم</h1>

  <div id="msg" class="warn"></div>

  <label>اسم المنتج</label>
  <input id="q" type="text" placeholder="مثال: عجول، اغنام، بيجو...">

  <label>وزن الحمل (كغ)</label>
  <input id="weight" type="number" placeholder="مثال: 5000">

  <label>سعر الصرف (دينار لكل دولار)</label>
  <input id="exchangeRate" type="number" value="1320">

  <label>النسبة (%)</label>
  <input id="rate" type="number" value="6" step="0.1">

  <button id="btn">احسب</button>

  <div id="out" class="result" hidden></div>

  <div style="margin-top:10px">
    <label for="file">أو حمّل ملف JSON يدويًا</label>
    <input id="file" type="file" accept=".json,application/json">
  </div>
</div>

<script>
let DB=[];
const normalize=s=>(s||'').toString().trim().toLowerCase();
const fmt=x=>{const n=Number(x);return isFinite(n)?n.toLocaleString('ar-IQ',{maximumFractionDigits:2}):'-';};

function prepare(arr){
  return arr.map(r=>{
    const product=r.product ?? r.GDS_DS2 ?? r.name ?? "";
    const min=Number(r.GDS_MIN), max=Number(r.GDS_MAX);
    const yer=(r.GDS_YER!=null && r.GDS_YER!=="")?Number(r.GDS_YER):(isFinite(min)&&isFinite(max)?(min+max)/2:null);
    return {product,GDS_MIN:min,GDS_MAX:max,GDS_YER:yer};
  }).filter(r=>r.product);
}

function find(name){
  const q=normalize(name); if(!q) return null;
  return DB.find(r=>normalize(r.product).includes(q)) || null;
}

async function loadDB(){
  try{
    const res=await fetch('products.json',{cache:'no-store'});
    if(!res.ok) throw new Error(res.status);
    DB=prepare(await res.json());
    document.getElementById('msg').textContent='';
  }catch(e){
    document.getElementById('msg').textContent='⚠️ لم أستطع قراءة products.json تلقائيًا. ممكن تحمل الملف يدويًا من الأسفل.';
  }
}

function run(){
  const name=document.getElementById('q').value;
  const w=parseFloat(document.getElementById('weight').value);
  const ex=parseFloat(document.getElementById('exchangeRate').value);
  const rate=parseFloat(document.getElementById('rate').value);
  const out=document.getElementById('out'); out.hidden=false;

  const rec=find(name);
  if(!rec){ out.innerHTML="⚠️ المنتج غير موجود"; return; }
  if(isNaN(w)||w<=0){ out.innerHTML="⚠️ أدخل وزنًا صحيحًا"; return; }

  const diff = w * Number(rec.GDS_YER) * ex * (rate/100);

  out.innerHTML=`
    <div class="kv"><div>🏷️ المنتج</div><div><b>${rec.product}</b></div></div>
    <div class="kv"><div>GDS_MIN</div><div>${fmt(rec.GDS_MIN)}</div></div>
    <div class="kv"><div>GDS_MAX</div><div>${fmt(rec.GDS_MAX)}</div></div>
    <div class="kv"><div>💰 GDS_YER</div><div><b>${fmt(rec.GDS_YER)}</b></div></div>
    <div class="kv"><div>⚖️ الوزن (كغ)</div><div>${fmt(w)}</div></div>
    <div class="kv"><div>🔢 سعر الصرف</div><div>${fmt(ex)}</div></div>
    <div class="kv"><div>📊 النسبة</div><div>${rate}%</div></div>
    <div class="kv"><div>✅ فرق الرسم (دينار)</div><div><b>${fmt(diff)}</b></div></div>
  `;
}

// دعم التحميل اليدوي
document.getElementById('file').addEventListener('change', (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{ DB=prepare(JSON.parse(reader.result)); document.getElementById('msg').textContent=''; }
    catch(err){ alert('JSON غير صالح: '+err.message); }
  };
  reader.readAsText(f,'utf-8');
});

document.getElementById('btn').addEventListener('click', run);

// لو جاي من الجدول باسم المنتج
const params=new URLSearchParams(location.search);
if(params.has('name')){ document.getElementById('q').value=params.get('name'); }

loadDB();
</script>
</body>
</html>
