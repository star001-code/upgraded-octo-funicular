<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>ğŸ” Ø§Ù„Ø­Ø§Ø³Ø¨Ø© (GDS_YER Ã— ÙˆØ²Ù† Ã— Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ã— Ø§Ù„Ù†Ø³Ø¨Ø©)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:Arial,"Noto Naskh Arabic",sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:24px}
  .card{max-width:720px;margin:auto;background:#111827;border:1px solid #1f2937;border-radius:14px;padding:20px}
  h1{margin:0 0 16px}
  label{display:block;color:#aab3c5;margin:8px 0 4px}
  input,button{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  button{background:#2563eb;cursor:pointer;margin-top:10px}
  .result{margin-top:16px;padding:14px;border-radius:12px;background:#0b1220;line-height:1.8}
  .kv{display:grid;grid-template-columns:1fr auto;gap:8px;padding:6px 0;border-bottom:1px solid #1f2937}
  .warn{color:#fca5a5;font-size:12px}
</style>
</head>
<body>
<div class="card">
  <h1>ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ + Ø­Ø³Ø§Ø¨ ÙØ±Ù‚ Ø§Ù„Ø±Ø³Ù…</h1>

  <div id="msg" class="warn"></div>

  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
  <input id="q" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø¬ÙˆÙ„ØŒ Ø§ØºÙ†Ø§Ù…ØŒ Ø¨ÙŠØ¬Ùˆ...">

  <label>ÙˆØ²Ù† Ø§Ù„Ø­Ù…Ù„ (ÙƒØº)</label>
  <input id="weight" type="number" placeholder="Ù…Ø«Ø§Ù„: 5000">

  <label>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (Ø¯ÙŠÙ†Ø§Ø± Ù„ÙƒÙ„ Ø¯ÙˆÙ„Ø§Ø±)</label>
  <input id="exchangeRate" type="number" value="1320">

  <label>Ø§Ù„Ù†Ø³Ø¨Ø© (%)</label>
  <input id="rate" type="number" value="6" step="0.1">

  <button id="btn">Ø§Ø­Ø³Ø¨</button>

  <div id="out" class="result" hidden></div>

  <div style="margin-top:10px">
    <label for="file">Ø£Ùˆ Ø­Ù…Ù‘Ù„ Ù…Ù„Ù JSON ÙŠØ¯ÙˆÙŠÙ‹Ø§</label>
    <input id="file" type="file" accept=".json,application/json">
  </div>
</div>

<script>
let DB=[];
const normalize=s=>(s||'').toString().trim().toLowerCase();
const fmt=x=>{const n=Number(x);return isFinite(n)?n.toLocaleString('ar-IQ',{maximumFractionDigits:2}):'-';};

function prepare(arr){
  return arr.map(r=>{
    const product=r.product ?? r.GDS_DS2 ?? r.name ?? "";
    const min=Number(r.GDS_MIN), max=Number(r.GDS_MAX);
    const yer=(r.GDS_YER!=null && r.GDS_YER!=="")?Number(r.GDS_YER):(isFinite(min)&&isFinite(max)?(min+max)/2:null);
    return {product,GDS_MIN:min,GDS_MAX:max,GDS_YER:yer};
  }).filter(r=>r.product);
}

function find(name){
  const q=normalize(name); if(!q) return null;
  return DB.find(r=>normalize(r.product).includes(q)) || null;
}

async function loadDB(){
  try{
    const res=await fetch('products.json',{cache:'no-store'});
    if(!res.ok) throw new Error(res.status);
    DB=prepare(await res.json());
    document.getElementById('msg').textContent='';
  }catch(e){
    document.getElementById('msg').textContent='âš ï¸ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ù‚Ø±Ø§Ø¡Ø© products.json ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ù…Ù…ÙƒÙ† ØªØ­Ù…Ù„ Ø§Ù„Ù…Ù„Ù ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„.';
  }
}

function run(){
  const name=document.getElementById('q').value;
  const w=parseFloat(document.getElementById('weight').value);
  const ex=parseFloat(document.getElementById('exchangeRate').value);
  const rate=parseFloat(document.getElementById('rate').value);
  const out=document.getElementById('out'); out.hidden=false;

  const rec=find(name);
  if(!rec){ out.innerHTML="âš ï¸ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; return; }
  if(isNaN(w)||w<=0){ out.innerHTML="âš ï¸ Ø£Ø¯Ø®Ù„ ÙˆØ²Ù†Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§"; return; }

  const diff = w * Number(rec.GDS_YER) * ex * (rate/100);

  out.innerHTML=`
    <div class="kv"><div>ğŸ·ï¸ Ø§Ù„Ù…Ù†ØªØ¬</div><div><b>${rec.product}</b></div></div>
    <div class="kv"><div>GDS_MIN</div><div>${fmt(rec.GDS_MIN)}</div></div>
    <div class="kv"><div>GDS_MAX</div><div>${fmt(rec.GDS_MAX)}</div></div>
    <div class="kv"><div>ğŸ’° GDS_YER</div><div><b>${fmt(rec.GDS_YER)}</b></div></div>
    <div class="kv"><div>âš–ï¸ Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</div><div>${fmt(w)}</div></div>
    <div class="kv"><div>ğŸ”¢ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</div><div>${fmt(ex)}</div></div>
    <div class="kv"><div>ğŸ“Š Ø§Ù„Ù†Ø³Ø¨Ø©</div><div>${rate}%</div></div>
    <div class="kv"><div>âœ… ÙØ±Ù‚ Ø§Ù„Ø±Ø³Ù… (Ø¯ÙŠÙ†Ø§Ø±)</div><div><b>${fmt(diff)}</b></div></div>
  `;
}

// Ø¯Ø¹Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
document.getElementById('file').addEventListener('change', (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{ DB=prepare(JSON.parse(reader.result)); document.getElementById('msg').textContent=''; }
    catch(err){ alert('JSON ØºÙŠØ± ØµØ§Ù„Ø­: '+err.message); }
  };
  reader.readAsText(f,'utf-8');
});

document.getElementById('btn').addEventListener('click', run);

// Ù„Ùˆ Ø¬Ø§ÙŠ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
const params=new URLSearchParams(location.search);
if(params.has('name')){ document.getElementById('q').value=params.get('name'); }

loadDB();
</script>
</body>
</html>
